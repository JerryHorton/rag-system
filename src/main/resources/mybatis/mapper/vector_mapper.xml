<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.cug.sxy.ai.infrastructure.dao.IVectorDao">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="cn.cug.sxy.ai.infrastructure.dao.po.VectorPO">
        <id column="id" property="id"/>
        <result column="external_id" property="externalId"/>
        <result column="vector_type" property="vectorType"/>
        <result column="dimensions" property="dimensions"/>
        <result column="embedding" property="embedding"/>
        <result column="index_name" property="indexName"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="metadata" property="metadata"/>
        <result column="embedding_model" property="embeddingModel"/>
        <result column="vector_norm" property="vectorNorm"/>
        <result column="vector_category" property="vectorCategory"/>
        <result column="content_summary" property="contentSummary"/>
        <result column="space_type" property="spaceType"/>
        <result column="is_primary" property="isPrimary"/>
    </resultMap>

    <!-- 所有列 -->
    <sql id="Base_Column_List">
        id, external_id, vector_type, dimensions, embedding, index_name,
        create_time, update_time, metadata, embedding_model, vector_norm,
        vector_category, content_summary, space_type, is_primary
    </sql>

    <!-- 插入新向量 -->
    <insert id="insert" parameterType="cn.cug.sxy.ai.infrastructure.dao.po.VectorPO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO t_vector (external_id, vector_type, dimensions, embedding, index_name,
                              create_time, update_time, metadata, embedding_model, vector_norm,
                              vector_category, content_summary, space_type, is_primary)
        VALUES (#{externalId,jdbcType=VARCHAR},
                #{vectorType},
                #{dimensions},
                #{embedding},
                #{indexName},
                #{createTime},
                #{updateTime},
                #{metadata}::jsonb,
                #{embeddingModel},
                #{vectorNorm},
                #{vectorCategory},
                #{contentSummary},
                #{spaceType},
                #{isPrimary})
    </insert>

    <!-- 批量插入多个向量 -->
    <insert id="batchInsert" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_vector (
        external_id, vector_type, dimensions, embedding, index_name,
        create_time, update_time, metadata, embedding_model, vector_norm,
        vector_category, content_summary, space_type, is_primary
        )
        VALUES
        <foreach collection="vectors" item="item" separator=",">
            (
            #{item.externalId},
            #{item.vectorType},
            #{item.dimensions},
            #{item.embedding},
            #{item.indexName},
            #{item.createTime},
            #{item.updateTime},
            #{item.metadata}::jsonb,
            #{item.embeddingModel},
            #{item.vectorNorm},
            #{item.vectorCategory},
            #{item.contentSummary},
            #{item.spaceType},
            #{item.isPrimary}
            )
        </foreach>
    </insert>

    <!-- 根据ID更新向量 -->
    <update id="updateById" parameterType="cn.cug.sxy.ai.infrastructure.dao.po.VectorPO">
        UPDATE t_vector
        <set>
            <if test="externalId != null">external_id = #{externalId},</if>
            <if test="vectorType != null">vector_type = #{vectorType},</if>
            <if test="dimensions != null">dimensions = #{dimensions},</if>
            <if test="embedding != null">embedding = #{embedding},</if>
            <if test="indexName != null">index_name = #{indexName},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="metadata != null">metadata = #{metadata}::jsonb,</if>
            <if test="embeddingModel != null">embedding_model = #{embeddingModel},</if>
            <if test="vectorNorm != null">vector_norm = #{vectorNorm},</if>
            <if test="vectorCategory != null">vector_category = #{vectorCategory},</if>
            <if test="contentSummary != null">content_summary = #{contentSummary},</if>
            <if test="spaceType != null">space_type = #{spaceType},</if>
            <if test="isPrimary != null">is_primary = #{isPrimary},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除向量 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE
        FROM t_vector
        WHERE id = #{id}
    </delete>

    <!-- 根据外部ID删除向量 -->
    <delete id="deleteByExternalId" parameterType="java.lang.String">
        DELETE
        FROM t_vector
        WHERE external_id = #{externalId}
    </delete>

    <!-- 根据ID查询向量 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE id = #{id}
    </select>

    <!-- 根据外部ID查询向量 -->
    <select id="selectByExternalId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE external_id = #{externalId}
    </select>

    <!-- 根据向量类型查询向量列表 -->
    <select id="selectByVectorType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE vector_type = #{vectorType}
        ORDER BY create_time DESC
    </select>

    <!-- 根据索引名称查询向量列表 -->
    <select id="selectByIndexName" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE index_name = #{indexName}
        ORDER BY create_time DESC
    </select>

    <!-- 根据条件查询向量列表 -->
    <select id="selectByCondition" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        <where>
            <if test="externalId != null">
                AND external_id = #{externalId}
            </if>
            <if test="vectorType != null">
                AND vector_type = #{vectorType}
            </if>
            <if test="indexName != null">
                AND index_name = #{indexName}
            </if>
            <if test="embeddingModel != null">
                AND embedding_model = #{embeddingModel}
            </if>
            <if test="vectorCategory != null">
                AND vector_category = #{vectorCategory}
            </if>
            <if test="spaceType != null">
                AND space_type = #{spaceType}
            </if>
            <if test="isPrimary != null">
                AND is_primary = #{isPrimary}
            </if>
            <if test="dimensions != null">
                AND dimensions = #{dimensions}
            </if>
            <if test="startTime != null">
                AND create_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 统计各向量类型的数量 -->
    <select id="countByVectorType" resultType="java.util.Map">
        SELECT vector_type, COUNT(id) as count
        FROM t_vector
        GROUP BY vector_type
    </select>

    <!-- 统计各索引的向量数量 -->
    <select id="countByIndexName" resultType="java.util.Map">
        SELECT index_name, COUNT(id) as count
        FROM t_vector
        GROUP BY index_name
    </select>

    <!-- 根据ID列表批量查询向量 -->
    <select id="selectByIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 根据外部ID列表批量查询向量 -->
    <select id="selectByExternalIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE external_id IN
        <foreach item="externalId" collection="externalIds" open="(" separator="," close=")">
            #{externalId}
        </foreach>
    </select>

    <!-- 根据向量类别查询向量列表 -->
    <select id="selectByVectorCategory" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE vector_category = #{vectorCategory}
        ORDER BY create_time DESC
    </select>

    <!-- 根据空间类型查询向量列表 -->
    <select id="selectBySpaceType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_vector
        WHERE space_type = #{spaceType}
        ORDER BY create_time DESC
    </select>

    <!-- 更新向量的pgvector列 -->
    <update id="updateEmbedding">
        UPDATE t_vector
        SET embedding   = ${embeddingLiteral},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 基于pgvector的TopK近邻查询 -->
    <select id="selectNearestByEmbedding" resultType="cn.cug.sxy.ai.infrastructure.repository.dto.NearestVectorRow">
        SELECT id AS id,
        external_id AS externalId,
        index_name AS indexName,
        (1 - (embedding &lt;=&gt; ${queryLiteral})) AS score
        FROM t_vector
        <where>
            <if test="dimensions != null">
                AND dimensions = #{dimensions}
            </if>
            <if test="indexName != null and indexName != ''">
                AND index_name = #{indexName}
            </if>
        </where>
        ORDER BY embedding &lt;=&gt; ${queryLiteral}
        LIMIT #{topK}
    </select>

</mapper>
