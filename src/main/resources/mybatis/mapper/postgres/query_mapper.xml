<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.cug.sxy.ai.infrastructure.dao.postgres.IQueryDao">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="cn.cug.sxy.ai.infrastructure.dao.po.QueryPO">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="session_id" property="sessionId"/>
        <result column="original_text" property="originalText"/>
        <result column="processed_text" property="processedText"/>
        <result column="status" property="status"/>
        <result column="query_type" property="queryType"/>
        <result column="route_target" property="routeTarget"/>
        <result column="create_time" property="createTime"/>
        <result column="complete_time" property="completeTime"/>
        <result column="latency_ms" property="latencyMs"/>
        <result column="metadata" property="metadata"/>
        <result column="query_variants" property="queryVariants"/>
        <result column="decomposed_queries" property="decomposedQueries"/>
        <result column="response_ids" property="responseIds"/>
        <result column="error_message" property="errorMessage"/>
        <result column="retrieval_params" property="retrievalParams"/>
    </resultMap>

    <!-- 所有列 -->
    <sql id="Base_Column_List">
        id, user_id, session_id, original_text, processed_text, status, query_type,
        route_target, create_time, complete_time, latency_ms, metadata,
        query_variants, decomposed_queries, response_ids, error_message,
        retrieval_params
    </sql>

    <!-- 插入新查询 -->
    <insert id="insert" parameterType="cn.cug.sxy.ai.infrastructure.dao.po.QueryPO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO query (
            user_id, session_id, original_text, processed_text, status, query_type,
            route_target, create_time, complete_time, latency_ms, metadata,
            query_variants, decomposed_queries, response_ids, error_message,
            retrieval_params
        )
        VALUES (
                   #{userId},
                   #{sessionId},
                   #{originalText},
                   #{processedText},
                   #{status},
                   #{queryType},
                   #{routeTarget},
                   #{createTime},
                   #{completeTime},
                   #{latencyMs},
                   #{metadata}::jsonb,
                   #{queryVariants},
                   #{decomposedQueries},
                   #{responseIds},
                   #{errorMessage},
                   #{retrievalParams}
               )
    </insert>

    <!-- 根据ID更新查询 -->
    <update id="updateById" parameterType="cn.cug.sxy.ai.infrastructure.dao.po.QueryPO">
        UPDATE query
        <set>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="sessionId != null">session_id = #{sessionId},</if>
            <if test="originalText != null">original_text = #{originalText},</if>
            <if test="processedText != null">processed_text = #{processedText},</if>
            <if test="status != null">status = #{status},</if>
            <if test="queryType != null">query_type = #{queryType},</if>
            <if test="routeTarget != null">route_target = #{routeTarget},</if>
            <if test="completeTime != null">complete_time = #{completeTime},</if>
            <if test="latencyMs != null">latency_ms = #{latencyMs},</if>
            <if test="metadata != null">metadata = #{metadata}::jsonb,</if>
            <if test="queryVariants != null">query_variants = #{queryVariants},</if>
            <if test="decomposedQueries != null">decomposed_queries = #{decomposedQueries},</if>
            <if test="responseIds != null">response_ids = #{responseIds},</if>
            <if test="errorMessage != null">error_message = #{errorMessage},</if>
            <if test="retrievalParams != null">retrieval_params = #{retrievalParams},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除查询 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM query WHERE id = #{id}
    </delete>

    <!-- 根据ID查询 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        WHERE id = #{id}
    </select>

    <!-- 根据用户ID查询列表 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        WHERE user_id = #{userId}
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 根据会话ID查询列表 -->
    <select id="selectBySessionId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        WHERE session_id = #{sessionId}
        ORDER BY create_time ASC
    </select>

    <!-- 根据条件查询列表 -->
    <select id="selectByCondition" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        <where>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="sessionId != null">
                AND session_id = #{sessionId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="queryType != null">
                AND query_type = #{queryType}
            </if>
            <if test="routeTarget != null">
                AND route_target = #{routeTarget}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (original_text LIKE CONCAT('%', #{keyword}, '%')
                OR processed_text LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="startTime != null">
                AND create_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 更新查询状态和完成时间 -->
    <update id="updateStatus">
        UPDATE query
        <set>
            status = #{status},
            complete_time = #{completeTime},
            latency_ms = #{latencyMs},
            <if test="errorMessage != null">
                error_message = #{errorMessage},
            </if>
            <if test="errorMessage == null">
                error_message = NULL
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据时间范围查询列表 -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        WHERE create_time >= #{startTime}
        AND create_time &lt;= #{endTime}
        ORDER BY create_time DESC
    </select>

    <!-- 根据查询类型查询列表 -->
    <select id="selectByQueryType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        WHERE query_type = #{queryType}
        ORDER BY create_time DESC
    </select>

    <!-- 根据路由目标查询列表 -->
    <select id="selectByRouteTarget" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM query
        WHERE route_target = #{routeTarget}
        ORDER BY create_time DESC
    </select>

    <!-- 统计一定时间段内各种状态的查询数量 -->
    <select id="countByStatus" resultType="java.util.Map">
        SELECT status, COUNT(id) as count
        FROM query
        <where>
            <if test="startTime != null and endTime != null">
                create_time >= #{startTime}
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        GROUP BY status
    </select>

    <!-- 统计一定时间段内各种查询类型的查询数量 -->
    <select id="countByQueryType" resultType="java.util.Map">
        SELECT query_type, COUNT(id) as count
        FROM query
        <where>
            <if test="startTime != null and endTime != null">
                create_time >= #{startTime}
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        GROUP BY query_type
    </select>

    <!-- 查询平均响应时间 -->
    <select id="selectAvgLatency" resultType="java.lang.Double">
        SELECT AVG(latency_ms)
        FROM query
        <where>
            <if test="startTime != null and endTime != null">
                create_time >= #{startTime}
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        AND latency_ms IS NOT NULL
        AND status = 'COMPLETED'
    </select>

    <!-- 关联响应IDs -->
    <update id="updateResponseIds">
        UPDATE query
        SET response_ids = #{responseIds}
        WHERE id = #{id}
    </update>

</mapper>
